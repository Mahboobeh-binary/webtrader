define(["jquery","windows/windows","websockets/binary_websockets","navigation/menu","moment","lodash","jquery-growl","common/util","highstock","highcharts-exporting","export-csv"],function(a,b,c,d,e,f){function g(a){var b=void 0;return k.forEach(function(c){c.submarkets.forEach(function(c){var d=f.find(c.instruments,function(b){return b.symbol===a});return f.isUndefined(d)||(b=d),f.isUndefined(d)})}),b}function h(b,d){a(".downloadChart").highcharts()&&a(".downloadChart").highcharts().destroy(),a(".downloadChart").highcharts("StockChart",{chart:{zoomType:"x",events:{load:function(){this.credits.element.onclick=function(){window.open("http://www.binary.com","_blank")}}},spacingLeft:0,marginLeft:40},navigator:{enabled:!0},scrollbar:{liveRedraw:!1},plotOptions:{candlestick:{lineColor:"black",color:"red",upColor:"green",upLineColor:"black",shadow:!0}},title:{text:g(a(".download_instruments span").data("symbol")).display_name+" ("+a(".download_timePeriod").val()+")"},credits:{href:"http://www.binary.com",text:"Binary.com"},xAxis:{labels:{formatter:function(){var a=this.axis.defaultLabelFormatter.call(this);return a.replace(".","")}}},yAxis:[{opposite:!1,labels:{formatter:function(){return this.value}}}],tooltip:{crosshairs:[{width:2,color:"red",dashStyle:"dash"},{width:2,color:"red",dashStyle:"dash"}],enabled:!0,enabledIndicators:!0,xDateFormat:"%A, %b %e, %Y %H:%M:%S"},exporting:{enabled:!0,buttons:{contextButton:{menuItems:[{text:"Download PNG",onclick:function(){this.exportChart()}},{text:"Download JPEG",onclick:function(){this.exportChart({type:"image/jpeg"})},separator:!1},{text:"Download PDF",onclick:function(){this.exportChart({type:"application/pdf"})},separator:!1},{text:"Download SVG",onclick:function(){this.exportChart({type:"image/svg+xml"})},separator:!1},{text:"Download CSV",onclick:function(){this.downloadCSV()},separator:!1},{text:"Download XLS",onclick:function(){this.downloadXLS()},separator:!1}]}}},rangeSelector:{enabled:!1}});var f=a(".downloadChart").highcharts();f.showLoading();var h=e.utc(a(".download_frmDate").val()+" "+a(".download_frmTime").val(),"DD/MM/YYYY HH:mm").unix(),i=e.utc(a(".download_toDate").val()+" "+a(".download_toTime").val(),"DD/MM/YYYY HH:mm").unix(),j={ticks_history:b,start:h,end:i};isTick(d)||(j.granularity=convertToTimeperiodObject(d).timeInSeconds(),j.style="candles"),c.send(j).then(function(a){var c=[];isTick(d)?a.history.times.forEach(function(b,d){c.push([1e3*parseInt(b),parseFloat(a.history.prices[d])])}):a.candles.forEach(function(a){c.push([1e3*a.epoch,parseFloat(a.open),parseFloat(a.high),parseFloat(a.low),parseFloat(a.close)])});var e=c.length,h=c.length>100?e-100:0;f.xAxis[0].range=c[e-1][0]-c[h][0];var i=b,j=g(b);j&&(i=j.display_name);var k={id:"_"+Date.now(),name:i,data:c,type:isTick(d)?"line":"candlestick",dataGrouping:{enabled:!1},states:{hover:{enabled:!1}}};isTick(d)&&(k.marker={enabled:!0,radius:4}),f.addSeries(k),f.hideLoading()})["catch"](function(b){a.growl.error({message:b.message}),f.hideLoading()})}function i(g){require(["css!download/download.css"]),g.click(function(){j?j.moveToTop():(j=b.createBlankWindow(a("<div/>"),{title:"Download/View Data",width:650,minHeight:500,height:500,resize:function(){var b=a(".downloadChart").width(a(this).width()+2).height(a(this).height()-88).highcharts();b&&b.reflow()}}),j.css("overflow","hidden"),j.dialog("open"),require(["text!download/download.html"],function(b){b=a(b),b.find("button, input[type=button]").button(),b.find(".download_frmDate").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"dd/mm/yy",showButtonPanel:!0,minDate:e.utc().subtract(1,"years").toDate(),maxDate:e.utc().toDate()}),b.find(".download_frmTime").timepicker({showCloseButton:!0}),b.find(".download_toDate").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"dd/mm/yy",showButtonPanel:!0,minDate:e.utc().subtract(1,"years").toDate(),maxDate:e.utc().toDate()}),b.find(".download_toTime").timepicker({showCloseButton:!0}),b.appendTo(j),b.find("select").selectmenu({width:"auto"}),c.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(b){k=d.extractChartableMarkets(b),k=d.sortMenu(k);var c=a("<ul>"),e="",g="";k.forEach(function(b){var d=a("<ul>");b.submarkets.forEach(function(b){var c=a("<ul>");b.instruments.forEach(function(b){var d=a("<li>");d.data("symbol",b.symbol),d.append(b.display_name),d.click(function(){a(".download_instruments span").data("symbol",a(this).data("symbol")).html(a(this).html())}),c.append(d),f.isEmpty(e)&&(e=b.symbol,g=b.display_name)}),d.append(a("<li>").append(b.name).append(c))}),c.append(a("<li>").append(b.name).append(d))}),a(".download_instruments").append(c),a("#download_instrument_menu").menu().menu("refresh"),a(".download_instruments span").data("symbol",e),a(".download_instruments span").html(g),h(e,a(".download_timePeriod").val())})["catch"](function(b){a.growl.error({message:b.message})}),b.find(".download_show").click(function(){var b=e.utc(a(".download_frmDate").val()+" "+a(".download_frmTime").val(),"DD/MM/YYYY HH:mm").unix(),c=e.utc(a(".download_toDate").val()+" "+a(".download_toTime").val(),"DD/MM/YYYY HH:mm").unix();b>c?a.growl.error({message:"To date is less than From date"}):h(a(".download_instruments span").data("symbol"),a(".download_timePeriod").val())}),b.find(".download_frmDate").val(e.utc().subtract(1,"years").format("DD/MM/YYYY")),b.find(".download_toDate").val(e.utc().format("DD/MM/YYYY"))}))})}var j=null,k=[];return{init:i}});