define(["jquery","moment","lokijs","charts/chartingRequestMap","websockets/stream_handler","datatables"],function(a,b,c,d,e){function f(c){var f=c.find(".table-view"),g=c.find("#"+c.attr("id")+"_chart").data(),j=isTick(g.timePeriod),k=d.keyFor(g.instrumentCode,g.timePeriod),l=f.find("span.close");l.on("click",i.bind(null,c));var m=a("<table width='100%' class='portfolio-dialog display compact'/>");m.appendTo(f);var n=[{title:"Date",orderable:!1,render:function(a){return b.utc(a).format("YYYY-MM-DD HH:mm:ss")}},{title:"Open",orderable:!1},{title:"High",orderable:!1},{title:"Low",orderable:!1},{title:"Close",orderable:!1}];j&&(n=[{title:"Date",orderable:!1,render:function(a){return b.utc(a).format("YYYY-MM-DD HH:mm:ss")}},{title:"Tick",orderable:!1}]),m=m.dataTable({data:[],columns:n,paging:!1,ordering:!0,info:!1,order:[0,"desc"]}),m.parent().addClass("hide-search-input");var o=e.events.on("tick",function(a){if(a.key===k&&c.view_table_visible){var b=a.tick,d=[b.time,b.open];m.api().row.add(d),m.api().draw()}}),p=e.events.on("ohlc",function(a){if(a.key===k&&c.view_table_visible){var b=a.ohlc,d=[b.time,b.open,b.high,b.low,b.close];a.is_new?m.api().row.add(d):m.api().row(0).data(d),m.api().draw()}});return c.on("dialogdestroy",function(){e.events.off("tick",o),e.events.off("ohld",p)}),{show:h.bind(null,c,k),hide:i.bind(null,c)}}var g=d.barsTable,h=function(a,b){var c=a.find(".table-view"),d=a.find(".chart-view");c.animate({left:"0"},250),d.animate({left:"-100%"},250),j(a,b),a.view_table_visible=!0},i=function(a){var b=a.find(".table-view"),c=a.find(".chart-view");b.animate({left:"100%"},250),c.animate({left:"0"},250),a.view_table_visible=!1},j=function(a,b){var c=a.find("#"+a.attr("id")+"_chart").data(),d=isTick(c.timePeriod),e=a.find(".table-view"),f=g.chain().find({instrumentCdAndTp:b}).simplesort("time",!0).data(),h=f.map(function(a){return d?[a.time,a.open]:[a.time,a.open,a.high,a.low,a.close]}),i=e.find("table").DataTable();i.rows().remove(),i.rows.add(h),i.draw()};return{init:f}});