define(["jquery","windows/windows","websockets/binary_websockets","jquery-ui","datatables","jquery-growl"],function(a,b,c){"use strict";function d(a){a.click(function(){j?j.moveToTop():h()})}function e(a){var b=a.proposal_open_contract,c=b.contract_id,d=b.bid_price;if(k){var e=k.api().row("#"+c),f=e.data();if(!f)return;var g=f[3];f[3]=d,e.data(f);var h=k.find("#"+c);b.is_valid_to_sell?(h.removeClass("resale-not-offered"),g!==d&&h.removeClass("indicative-red indicative-green").addClass(1*d>1*g?"indicative-green":"indicative-red")):h.removeClass("indicative-red indicative-green").addClass("resale-not-offered")}}function f(b){if("subscribe"===b)++n,!m&&n>0&&c.send({proposal_open_contract:1,subscribe:1}).then(function(){m=!0})["catch"](function(b){a.growl.error({message:b.message})});else if("forget"===b)--n,m&&0===n&&c.send({forget_all:"proposal_open_contract"}).then(function(){m=!1})["catch"](function(a){m=!1});else{if("resubscribe"!==b)return;c.send({forget_all:"proposal_open_contract"}).then(function(){return m=!1,c.send({proposal_open_contract:1,subscribe:1})})["catch"](function(a){m=!1})}}function g(a){if("IMG"===a.target.tagName){var b=a.target.parentElement.parentElement,c=k.api().row(b).data(),d=_.last(c);require(["viewtransaction/viewTransaction"],function(a){a.init(d.contract_id,d.transaction_id)})}}function h(){require(["css!portfolio/portfolio.css"]),c.send({balance:1}).then(function(d){var h=function(b){"minimized"===j.dialogExtend("state")&&j.dialogExtend("restore"),c.send({balance:1})["catch"](function(b){a.growl.error({message:b.message})}),i(),f(b===!0?"subscribe":"resubscribe")};c.events.on("balance",function(a){n=a.balance.currency,l.update(a.balance.balance)}),c.events.on("transaction",function(a){a.transaction;i(),f("resubscribe")}),j=b.createBlankWindow(a("<div/>"),{title:"Portfolio",width:700,minHeight:60,"data-authorized":"true",close:function(){f("forget"),c.events.off("proposal_open_contract",e)},open:function(){h(!0),c.events.on("proposal_open_contract",e)},destroy:function(){k&&k.DataTable().destroy(!0),j=null},refresh:h});var m=j.parent().find(".ui-dialog-title").addClass("with-content");l=a('<span class="span-in-dialog-header" />').insertAfter(m),l.update=function(a){l.html("Account balance: <strong>"+n+" "+formatPrice(a)+"</strong>")};var n=d.balance.currency;k=a("<table width='100%' class='portfolio-dialog display compact'/>"),k.appendTo(j),k=k.dataTable({data:[],columns:[{title:"Ref."},{title:"Contract Details"},{title:"Purchase",render:function(a){return n+' <span class="bold">'+a+"</span>"}},{title:"Indicative",render:function(a){return n+' <span class="bold">'+a+"</span>"}}],rowId:"4",paging:!1,ordering:!1,processing:!0}),k.parent().addClass("hide-search-input"),j.on("click",g),j.dialog("open")})["catch"](function(a){})}function i(){var b=a("#"+k.attr("id")+"_processing").show();c.send({portfolio:1}).then(function(a){var c=a.portfolio&&a.portfolio.contracts,d=c.map(function(a){var b="up",c='<img class="arrow" src="images/'+b+'-arrow.svg"/>';return[a.transaction_id,c+a.longcode,formatPrice(a.buy_price),"0.00",a.contract_id,a]});k.api().rows().remove(),k.api().rows.add(d),k.api().draw(),b.hide()})["catch"](function(c){k.api().rows().remove(),k.api().draw(),b.hide(),a.growl.error({message:c.message})})}var j=null,k=null,l=null,m=!1,n=0;return c.events.on("logout",function(){m=!1,n=0}),{proposal_open_contract:{subscribe:function(){f("subscribe")},forget:function(){f("forget")},resubscribe:function(){f("resubscribe")}},init:d}});